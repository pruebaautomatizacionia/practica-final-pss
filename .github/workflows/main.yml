name: DevOps Control Panel (AWS Backend)

on:
  workflow_dispatch:
    inputs:
      accion:
        description: 'Operación a realizar'
        required: true
        default: 'terraform_plan'
        type: choice
        options:
          - terraform_plan
          - terraform_apply
          - terraform_destroy
          - ansible_only
          - full_deploy

permissions:
  contents: write
  pull-requests: write

jobs:
  devops-job:
    runs-on: ubuntu-latest
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-north-1"
      TF_VAR_key_name: ${{ secrets.AWS_KEY_NAME }}

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      # --- LÓGICA DE TERRAFORM PLAN ---
      - name: Terraform Plan
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        run: |
          terraform plan -out=tfplan -no-color
          terraform show -no-color tfplan > plan_output.txt
          cat plan_output.txt
        working-directory: ./terraform
        
      - name: Upload Terraform Plan Artifact
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
        working-directory: ./terraform


      - name: Save Plan Output to Repo
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add terraform/plan_output.txt
          git commit -m "bot: update terraform plan output [skip ci]" || echo "No changes to commit"
          git push

      # --- LÓGICA DE TERRAFORM APPLY ---
      - name: Download Terraform Plan Artifact
        if: github.event.inputs.accion == 'terraform_apply' || github.event.inputs.accion == 'full_deploy'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: terraform
          
      - name: Terraform Apply
        if: github.event.inputs.accion == 'terraform_apply' || github.event.inputs.accion == 'full_deploy'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform

      # --- LÓGICA DE TERRAFORM DESTROY ---
      - name: Terraform Destroy
        if: github.event.inputs.accion == 'terraform_destroy'
        run: terraform destroy -auto-approve
        working-directory: ./terraform

      # --- GESTIÓN DE IPS DINÁMICAS (Para Ansible) ---
      # --- GESTIÓN DE IPS DINÁMICAS ---
      - name: Extraer IPs del State de S3
        id: get_ips
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy' || github.event.inputs.accion == 'terraform_apply'
        run: |
          # Forzamos una actualización del estado desde S3
          terraform refresh -no-color
          
          # Intentamos obtener las IPs. Si falla, esperamos 5 segundos y reintentamos.
          IPS=$(terraform output -json vm_public_ips | jq -r '.[]' || echo "")
          
          if [ -z "$IPS" ]; then
            echo "Esperando a que el estado se propague..."
            sleep 5
            IPS=$(terraform output -json vm_public_ips | jq -r '.[]')
          fi

          echo "lista_ips<<EOF" >> $GITHUB_OUTPUT
          echo "$IPS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: ./terraform

      # --- PREPARACIÓN DE ANSIBLE ---
      - name: Install Ansible collections
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy'
        run: ansible-galaxy collection install community.general

      # --- EJECUCIÓN DE ANSIBLE ---
      - name: Ejecutar Ansible Playbook
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy'
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/main.yml
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # El inventario se construye con las IPs obtenidas dinámicamente
          inventory: |
            [transfer_vms]
            ${{ steps.get_ips.outputs.lista_ips }}
          options: |
            --extra-vars "ansible_ssh_user=ubuntu"
