---
# Nombre: github_actions_ci_manual_terraform_only.yml
name: Manual CI Workflow para Terraform (Solo Terraform)

on:
  workflow_dispatch: # Permite la ejecución manual del workflow
    inputs:
      terraform_action:
        description: 'Acción de Terraform a ejecutar'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      terraform_target:
        description: 'Opcional: Especifique un recurso objetivo para la acción de Terraform (ej. aws_instance.my_instance)'
        required: false
        default: ''
        type: string

jobs:
  terraform_workflow:
    name: Terraform Execution (${{ github.event.inputs.terraform_action }})
    runs-on: ubuntu-latest # Utiliza un runner de Ubuntu gestionado por GitHub Actions.
    defaults:
      run:
        # Define que todos los comandos ejecutados en este job se harán dentro del directorio 'terraform'.
        # Esto es necesario porque 'main.tf' está ubicado en https://github.com/pruebaautomatizacionia/practica-final-pss/tree/main/terraform.
        working-directory: terraform

    steps:
      - name: Checkout del código
        uses: actions/checkout@v3 # Acción para descargar el código del repositorio al runner.

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v2 # Acción oficial para instalar y configurar Terraform CLI.
        with:
          # Se recomienda especificar una versión de Terraform para asegurar consistencia y reproducibilidad.
          terraform_version: 1.x.x # Por ejemplo: "1.5.x" o "1.5.7".

      - name: Inicializar Terraform
        id: init
        run: terraform init # Inicializa el directorio de trabajo de Terraform.

      - name: Validar la configuración de Terraform
        id: validate
        run: terraform validate -no-color # Realiza una comprobación de sintaxis y coherencia.

      - name: Crear un plan de Terraform
        # Este paso se ejecuta si la acción seleccionada es 'plan' o 'apply'.
        id: plan
        run: terraform plan -out=tfplan -no-color ${{ github.event.inputs.terraform_target != '' && format('-target=%s', github.event.inputs.terraform_target) || '' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1 # Asegúrate de que esta región coincida con la definida en tu main.tf.
        if: github.event.inputs.terraform_action == 'plan' || github.event.inputs.terraform_action == 'apply'
        continue-on-error: true # Permite continuar para mostrar el plan incluso si hay errores.

      - name: Mostrar el resultado del plan de Terraform
        run: |
          echo "Plan de Terraform generado:"
          echo "${{ steps.plan.outputs.stdout }}"
        if: github.event.inputs.terraform_action == 'plan' || github.event.inputs.terraform_action == 'apply'

      - name: Aplicar Terraform
        # Ejecuta terraform apply solo si la acción seleccionada es 'apply' y el plan fue exitoso.
        if: github.event.inputs.terraform_action == 'apply' && steps.plan.outcome == 'success'
        id: apply
        run: terraform apply -auto-approve tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      - name: Destruir Terraform
        # Ejecuta terraform destroy solo si la acción seleccionada es 'destroy'.
        # Se incluye un prompt de confirmación.
        if: github.event.inputs.terraform_action == 'destroy'
        id: destroy
        run: |
          echo "Vas a destruir la infraestructura. Escribe 'yes' para continuar:"
          read confirmation
          if [ "$confirmation" = "yes" ]; then
            terraform destroy -auto-approve ${{ github.event.inputs.terraform_target != '' && format('-target=%s', github.event.inputs.terraform_target) || '' }}
          else
            echo "Destrucción cancelada."
            exit 1
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east