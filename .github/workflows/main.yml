 ---
name: Terraform and Ansible CI/CD Workflow
on: workflow_dispatch
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Initialize Terraform and set variables
      - name: Setup Terraform
        id: terraform_setup
        uses: hashicorp/terraform-action@v5.4.0
        with:
          terraform_version: '1.4.7'
          backend: 'remote'
          backend_config: '{"location": "https://github.com/pruebaautomatizacionia/practica-final-pss/actions/jobs/terraform_remote_state"}'

      - name: Terraform Init
        id: terraform_init
        run: |
          terraform init -backend-config='{"location": "https://github.com/pruebaautomatizacionia/practica-final-pss/actions/jobs/terraform_remote_state"}'

      # Plan and Apply Terraform (can be separated into multiple steps for review)
      - name: Terraform Plan and Apply
        if: github.event_name != 'schedule'
        id: terraform_apply
        run: |
          terraform plan -out=tfplan
          echo "terraform_plan=tfplan" >> $GITHUB_OUTPUT
          terraform apply -auto-approve -input=tfplan
          echo "terraform_apply=success" >> $GITHUB_OUTPUT

      # Create Ansible inventory file with the latest Terraform output
      - name: Generate Ansible Inventory File
        if: github.event_name == 'push' && github.ref != 'HEAD'
        id: ansible_inventory
        run: |
          TF_VAR_db_password=$(cat $GITHUB_OUTPUT/terraform_apply)
          cat << EOF > inventory.ini
[web_servers]
${{ each.value.public_ip }}

[database]
${{ aws_db_instance.database.address }}:5432:${aws_db_instance.database.username}
EOF
          echo "ansible_inventory=inventory.ini" >> $GITHUB_OUTPUT

      # Run Ansible playbook
      - name: Run Ansible Playbook
        if: github.event_name == 'push' && github.ref != 'HEAD'
        uses: dschemata/detox@v2
        with:
          detox_args: "apply -i ansible/main.yml"
          inventory: ${{ env.HOME }}/inventory.ini
          extra_vars: "TF_VAR_db_password=${TF_VAR_db_passwor