---
name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev, staging, prod)'
        required: true
        default: 'dev'
      branch:
        description: 'Branch to deploy from'
        required: true
        default: 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/terraform-action@v5.4.0
        with:
          terraform_version: '1.4.7'
          backend: 'remote'
          backend_config: '{"location": "https://github.com/pruebaautomatizacionia/practica-final-pss/actions/jobs/terraform_remote_state"} '

      - name: Terraform Init
        id: terraform-init
        run: |
          terraform init -backend-config='{"location": "https://github.com/pruebaautomatizacionia/practica-final-pss/actions/jobs/terraform_remote_state"}'

      - name: Terraform Plan
        id: terraform-plan
        run: |
          terraform plan -out=tfplan
          echo "terraform_plan=tfplan" >> $GITHUB_OUTPUT

      - name: Terraform Apply
        if: steps.terraform-plan.outputs.terraform_plan != ''
        id: terraform-apply
        run: |
          terraform apply -auto-approve -input=tfplan
          echo "terraform_apply=success" >> $GITHUB_OUTPUT

      - name: Run Ansible
        if: steps.terraform-apply.outputs.terraform_apply == 'success'
        uses: dschemata/detox@v2
        with:
          detox_args: "apply -i ansible/main.yml"
          environment: ${{ github.event.inputs.environment }}
          branch: ${{ github.event.inputs.branch }}
