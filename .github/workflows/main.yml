name: DevOps Control Panel (AWS Backend)

on:
  workflow_dispatch:
    inputs:
      accion:
        description: 'Operación a realizar'
        required: true
        default: 'terraform_plan'
        type: choice
        options:
          - terraform_plan
          - terraform_apply
          - terraform_destroy
          - ansible_only
          - full_deploy

permissions:
  contents: write
  pull-requests: write

jobs:
  devops-job:
    runs-on: ubuntu-latest
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-north-1"
      TF_VAR_key_name: ${{ secrets.AWS_KEY_NAME }}
      TF_VAR_environment: "dev"
      TF_VAR_project: "prueba"
      TF_VAR_owner: "automacion"
      TF_VAR_subnet_ids: "[\"${{ secrets.AWS_SUBNET_ID }}\"]"
      TF_VAR_vpc_id: ${{ secrets.AWS_VPC_ID }}

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt check
        if: github.event.inputs.accion != 'ansible_only'
        run: terraform fmt -recursive -write=true
        working-directory: ./terraform

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform validate
        if: github.event.inputs.accion != 'ansible_only'
        run: terraform validate
        working-directory: ./terraform
        
      # --- LÓGICA DE TERRAFORM PLAN ---
      - name: Terraform Plan
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        run: |
          set +e
          terraform plan -detailed-exitcode -no-color -out=tfplan
          exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT

          if [ $exitcode -eq 2 ]; then
            echo "No changes detected"
          elif [ $exitcode -eq 0 ]; then
            echo "Changes detected"
            terraform show -no-color tfplan > plan_output.txt
            grep -A20 "Plan:" plan_output.txt
            
          else
            echo "Terraform plan failed"
            exit 1
          fi

          exit 0
    
        working-directory: ./terraform
        
      - name: Upload Terraform Plan Artifact
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ./terraform/tfplan

      - name: Save Plan Output to Repo
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add terraform/plan_output.txt
          git commit -m "bot: update terraform plan output [skip ci]" || echo "No changes to commit"
          git push

      # --- LÓGICA DE TERRAFORM APPLY ---      
      - name: Download Terraform Plan Artifact
        if: github.event.inputs.accion == 'terraform_apply' || github.event.inputs.accion == 'full_deploy'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: ./terraform

      - name: Terraform Apply
        if: github.event.inputs.accion == 'terraform_apply' || github.event.inputs.accion == 'full_deploy'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform

      # --- LÓGICA DE TERRAFORM DESTROY ---
      - name: Terraform Destroy
        if: github.event.inputs.accion == 'terraform_destroy'
        run: terraform destroy -auto-approve
        working-directory: ./terraform

      # --- GESTIÓN DE IPS DINÁMICAS (Para Ansible) ---
      # --- GESTIÓN DE IPS DINÁMICAS ---
      - name: Obtener IPs desde Terraform Outputs
        id: get_ips
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy' || github.event.inputs.accion == 'terraform_apply'
        run: |
          IPS=$(terraform state pull | jq -r '
          .resources[]
          | select(.type=="aws_instance")
          | .instances[].attributes.public_ip
          | select(. != null)'
          )

          echo "ips<<EOF" >> $GITHUB_OUTPUT
          echo "$IPS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: ./terraform


      # --- PREPARACIÓN DE ANSIBLE ---
      - name: Install Ansible
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy'
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Install Ansible collections
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy'
        run: ansible-galaxy collection install community.general
        
      - name: Ansible syntax check
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy'
        run: ansible-playbook ansible/main.yml --syntax-check

      - name: Construir inventario Ansible
        id: inventory
        run: |
          echo "[transfer_vms]" > inventory.ini
          echo "${{ steps.get_ips.outputs.ips }}" >> inventory.ini
          cat inventory.ini


      # --- EJECUCIÓN DE ANSIBLE ---
      - name: Ejecutar Ansible Playbook
        if: github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy'
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook ansible/main.yml \
            --inventory inventory.ini \
            --extra-vars "ansible_ssh_user=ubuntu"

