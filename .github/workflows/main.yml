name: DevOps Control Panel (AWS Backend)

on:
  workflow_dispatch:
    inputs:
      accion:
        description: 'Operación a realizar'
        required: true
        default: 'terraform_plan'
        type: choice
        options:
          - terraform_plan
          - terraform_apply
          - terraform_destroy
          - ansible_only
          - full_deploy

jobs:
  devops-job:
    runs-on: ubuntu-latest
    
    # Definimos variables de entorno para AWS para que Terraform las use
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-north-1" # Según tu archivo backend.tf

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # CONFIGURACIÓN DE HERRAMIENTAS
      # ----------------------------------------------------
      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        # El init detectará automáticamente el backend S3 definido en tus archivos .tf
        run: terraform init
        working-directory: ./terraform

      # ----------------------------------------------------
      # LÓGICA DE TERRAFORM
      # ----------------------------------------------------
      - name: Terraform Plan
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        run: terraform plan -no-color
        working-directory: ./terraform

      - name: Terraform Apply
        if: github.event.inputs.accion == 'terraform_apply' || github.event.inputs.accion == 'full_deploy'
        run: terraform apply -auto-approve
        working-directory: ./terraform

      - name: Terraform Destroy
        if: github.event.inputs.accion == 'terraform_destroy'
        run: terraform destroy -auto-approve
        working-directory: ./terraform

      # ----------------------------------------------------
      # LÓGICA DE ANSIBLE (Se activa si hay máquinas)
      # ----------------------------------------------------
      - name: Obtener IPs desde Backend S3
        id: get_ips
        if: contains(fromJson('["ansible_only", "full_deploy", "terraform_apply"]'), github.event.inputs.accion)
        run: |
          # Extrae las IPs del estado guardado en el bucket S3
          IP_JSON=$(terraform output -json vm_public_ips)
          echo "vm_ips=$IP_JSON" >> $GITHUB_OUTPUT
        working-directory: ./terraform
        continue-on-error: true

      - name: Ejecutar Ansible Playbook
        if: steps.get_ips.outputs.vm_ips != '' && (github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy')
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/main.yml
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          inventory: |
            [transfer_vms]
            {% for ip in fromJson(steps.get_ips.outputs.vm_ips) %}
            {{ ip }}
            {% endfor %}
