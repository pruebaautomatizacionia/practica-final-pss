name: DevOps Control Panel (AWS Backend)

on:
  workflow_dispatch:
    inputs:
      accion:
        description: 'Operación a realizar'
        required: true
        default: 'terraform_plan'
        type: choice
        options:
          - terraform_plan
          - terraform_apply
          - terraform_destroy
          - ansible_only
          - full_deploy

jobs:
  devops-job:
    runs-on: ubuntu-latest
    
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "eu-north-1"
      TF_VAR_key_name: ${{ secrets.AWS_KEY_NAME }}

    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Instalar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      # --- LOGICA DE PLAN Y REPORTE A N8N ---
      - name: Terraform Plan
        if: github.event.inputs.accion == 'terraform_plan' || github.event.inputs.accion == 'full_deploy'
        id: plan
        run: |
          terraform plan -no-color > plan_output.txt
          cat plan_output.txt
        working-directory: ./terraform
      - name: Save Plan Output to Repo
        if: github.event.inputs.operacion == 'terraform_plan'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add terraform/plan_output.txt
          git commit -m "bot: update terraform plan output [skip ci]" || echo "No changes to commit"
          git push

      # --- LOGICA DE EJECUCIÓN ---
      - name: Terraform Apply
        if: github.event.inputs.accion == 'terraform_apply' || github.event.inputs.accion == 'full_deploy'
        run: |
          terraform apply -auto-approve -no-color | tee apply_output.txt
        working-directory: ./terraform
      - name: Save Apply Output to Repo
        if: github.event.inputs.operacion == 'terraform_apply'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add terraform/apply_output.txt
          git commit -m "bot: update terraform apply output [skip ci]" || echo "No changes to commit"
          git push
          
      - name: Terraform Destroy
        if: github.event.inputs.accion == 'terraform_destroy'
        run: terraform destroy -auto-approve
        working-directory: ./terraform

      # --- GESTIÓN DE IPS (Extrae de S3 incluso en ansible_only) ---
      - name: Obtener IPs desde Backend S3
        id: get_ips
        if: contains(fromJson('["ansible_only", "full_deploy", "terraform_apply"]'), github.event.inputs.accion)
        run: |
          # Al estar el init hecho, output lee el estado actual en S3
          IP_JSON=$(terraform output -json vm_public_ips || echo "[]")
          echo "vm_ips=$IP_JSON" >> $GITHUB_OUTPUT
        working-directory: ./terraform

      # --- EJECUCIÓN DE ANSIBLE ---
      - name: Ejecutar Ansible Playbook
        # Se ejecuta si hay IPs y la acción es ansible_only o full_deploy
        if: steps.get_ips.outputs.vm_ips != '[]' && (github.event.inputs.accion == 'ansible_only' || github.event.inputs.accion == 'full_deploy')
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: ansible/main.yml
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          inventory: |
            [transfer_vms]
            {% for ip in fromJson(steps.get_ips.outputs.vm_ips) %}
            {{ ip }}
            {% endfor %}
