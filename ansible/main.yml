---
- hosts: transfer_vms
  become: yes
  remote_user: ubuntu
  tasks:
    - name: Update apt cache and install base packages
      apt:
        update_cache: yes
        name:
          - mysql-server
          - openjdk-8-jdk
          - apache2
          - vim
          - python3-pymysql  # OBLIGATORIO para que funcionen los m√≥dulos de MySQL
        state: present

    - name: Ensure MySQL is running
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Create transfer database
      community.general.mysql_db:
        name: transfer
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Create MySQL user for transfer project
      community.general.mysql_user:
        name: transfer_admin
        password: "{{ mysql_transfer_admin_password }}"
        priv: "transfer.*:ALL"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Create web directory
      file:
        path: /var/www/transfer
        state: directory
        mode: '0755'
        owner: www-data
        group: www-data

    - name: Restart services
      service:
        name: "{{ item }}"
        state: restarted
      loop:
        - mysql
        - apache2
