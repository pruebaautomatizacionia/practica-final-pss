---
# Nombre: ansible_install_nginx_and_configure.yml
# Playbook Ansible para instalar Nginx y configurarlo para servir contenido estático

- hosts: web_servers
  become: true # Ejecutar tareas con privilegios de root

  vars:
    nginx_conf_dir: "/etc/nginx/sites-available"
    nginx_enabled_dir: "/etc/nginx/sites-enabled"
    app_name: "my-static-site"
    app_source_path: "/var/www/my-static-site" # Ruta donde se copiará el contenido estático
    nginx_port: 80

  tasks:
    - name: Actualizar caché de paquetes (Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Instalar Nginx
      package:
        name: nginx
        state: present

    - name: Crear directorio para el contenido de la aplicación
      file:
        path: "{{ app_source_path }}"
        state: directory
        owner: www-data # Usuario bajo el que corre Nginx
        group: www-data
        mode: '0755'

    - name: Copiar contenido estático a la webroot
      copy:
        src: ./static_content/ # Asume que tienes un directorio 'static_content' en tu repositorio
        dest: "{{ app_source_path }}/"
        owner: www-data
        group: www-data
        mode: '0644'

    - name: Crear archivo de configuración de Nginx para la aplicación
      template:
        src: templates/nginx_static.conf.j2 # Este template debe crearse en un directorio 'templates'
        dest: "{{ nginx_conf_dir }}/{{ app_name }}"
      notify:
        - Recargar Nginx

    - name: Habilitar la configuración del sitio Nginx
      file:
        src: "{{ nginx_conf_dir }}/{{ app_name }}"
        dest: "{{ nginx_enabled_dir }}/{{ app_name }}"
        state: link # Crea un enlace simbólico
      notify:
        - Recargar Nginx

    - name: Eliminar la configuración por defecto de Nginx si existe
      file:
        path: "{{ nginx_enabled_dir }}/default"
        state: absent
      notify:
        - Recargar Nginx

    - name: Asegurar que Nginx esté iniciado y habilitado
      service:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: Recargar Nginx
      service:
        name: nginx
        state: reloaded
---
# Nombre: ansible_configure_firewall.yml
# Playbook Ansible para configurar reglas de firewall (ufw en Debian/Ubuntu)

- hosts: all
  become: true

  vars:
    allowed_ports:
      - 22 # SSH
      - 80 # HTTP
      - 443 # HTTPS
    ufw_rules_to_allow:
      - { port: "22", proto: "tcp" }
      - { port: "80", proto: "tcp" }
      - { port: "443", proto: "tcp" }
    # Ejemplo de regla para permitir un servicio específico
    # - { rule: "allow", name: "docker" } 

  tasks:
    - name: Asegurar que ufw esté instalado (Debian/Ubuntu)
      package:
        name: ufw
        state: present
      when: ansible_os_family == "Debian"

    - name: Habilitar el firewall ufw
      ufw:
        state: enabled
        policy: deny # Por defecto, denegar todo el tráfico entrante
      when: ansible_os_family == "Debian"

    - name: Permitir tráfico entrante según las reglas definidas
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop: "{{ ufw_rules_to_allow }}"
      when: ansible_os_family == "Debian"
      notify:
        - Recargar ufw

    # Ejemplo de cómo añadir una regla por nombre de servicio (si está bien definido en /etc/ufw/applications.d/)
    # - name: Permitir tráfico para el servicio 'myapp'
    #   ufw:
    #     rule: allow
    #     name: "myapp"
    #   when: ansible_os_family == "Debian"
    #   notify:
    #     - Recargar ufw

    - name: Permitir todo el tráfico saliente
      ufw:
        direction: outgoing
        policy: allow
      when: ansible_os_family == "Debian"

  handlers:
    - name: Recargar ufw
      command: sudo ufw reload
      when: ansible_os_family == "Debian"
---
# Nombre: ansible_install_monitoring_agent.yml
# Playbook Ansible para instalar un agente de monitoreo (ejemplo: Prometheus Node Exporter)

- hosts: monitoring_targets
  become: true

  vars:
    node_exporter_version: "1.7.0" # Versión específica del Node Exporter
    node_exporter_url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
    node_exporter_user: prometheus
    node_exporter_group: prometheus
    node_exporter_install_dir: "/usr/local/bin"
    node_exporter_data_dir: "/var/lib/prometheus"

  tasks:
    - name: Crear usuario y grupo para el agente (si no existen)
      user:
        name: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        create_home: yes
        shell: /usr/sbin/nologin # El agente no necesita shell interactivo
        state: present

    - name: Crear directorio de datos para el agente
      file:
        path: "{{ node_exporter_data_dir }}"
        state: directory
        owner: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        mode: '0755'

    - name: Descargar el binario del Node Exporter
      get_url:
        url: "{{ node_exporter_url }}"
        dest: "/tmp/node_exporter.tar.gz"
        mode: '0644'

    - name: Extraer el binario del Node Exporter
      unarchive:
        src: "/tmp/node_exporter.tar.gz"
        dest: "/tmp/"
        remote_src: yes # Indica que la fuente es un archivo en el sistema remoto (runner)
        creates: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter" # Evita re-extraer si ya existe

    - name: Mover el binario del Node Exporter a la ruta de instalación
      copy:
        src: "/tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
        dest: "{{ node_exporter_install_dir }}/node_exporter"
        owner: "{{ node_exporter_user }}"
        group: "{{ node_exporter_group }}"
        mode: '0755'
        remote_src: yes # Indica que la fuente es un archivo en el sistema remoto

    - name: Crear archivo de servicio systemd para Node Exporter
      template:
        src: templates/node_exporter.service.j2 # Este template debe crearse en un directorio 'templates'
        dest: /etc/systemd/system/node_exporter.service
      notify:
        - Recargar systemd y reiniciar Node Exporter

    - name: Asegurar que el servicio Node Exporter esté iniciado y habilitado
      systemd:
        name: node_exporter
        state: started
        enabled: yes
        daemon_reload: yes # Recarga la configuración de systemd

  handlers:
    - name: Recargar systemd y reiniciar Node Exporter
      systemd:
        name: node_exporter
        state: restarted
        daemon_reload: yes
```