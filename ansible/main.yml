---
# Nombre: ansible_deploy_app_from_git.yml
# Playbook Ansible para desplegar una aplicación web desde un repositorio Git

- hosts: webservers
  become: true # Ejecutar tareas con privilegios de root

  vars:
    app_repo_url: "https://github.com/tu_usuario/tu_aplicacion.git" # Reemplaza con tu URL de repositorio
    app_dest_path: "/var/www/mi_aplicacion"
    app_branch: "main" # Rama a desplegar
    app_service_name: nginx # O el nombre de tu servidor web/aplicación
    app_port: 80

  tasks:
    - name: Actualizar caché de apt (si aplica)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Instalar Git y el servidor web (ej. Nginx)
      package:
        name: "{{ item }}"
        state: present
      loop:
        - git
        - nginx # O 'apache2'
      when: ansible_os_family == "Debian"

    - name: Clonar o actualizar el repositorio de la aplicación
      git:
        repo: "{{ app_repo_url }}"
        dest: "{{ app_dest_path }}"
        version: "{{ app_branch }}"
        update: yes # Clona si no existe, o actualiza si ya existe

    - name: Crear archivo de configuración del servidor web (ej. Nginx)
      template:
        src: templates/nginx_app.conf.j2 # Debes crear este archivo en un directorio 'templates/'
        dest: "/etc/nginx/sites-available/{{ app_name }}"
      notify:
        - Recargar Servidor Web

    - name: Habilitar la configuración del sitio web
      file:
        src: "/etc/nginx/sites-available/{{ app_name }}"
        dest: "/etc/nginx/sites-enabled/{{ app_name }}"
        state: link
      notify:
        - Recargar Servidor Web

    - name: Asegurar que el servicio esté iniciado y habilitado
      service:
        name: "{{ app_service_name }}"
        state: started
        enabled: yes

  handlers:
    - name: Recargar Servidor Web
      service:
        name: "{{ app_service_name }}"
        state: reloaded
---
# Nombre: ansible_install_docker_and_compose.yml
# Playbook Ansible para instalar Docker Engine y Docker Compose

- hosts: docker_hosts
  become: true

  tasks:
    - name: Eliminar paquetes de Docker viejos (si existen)
      package:
        name: "{{ item }}"
        state: absent
      loop:
        - docker
        - docker-engine
        - docker.io
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-buildx-plugin
        - docker-compose-plugin
      when: ansible_os_family == "Debian"

    - name: Actualizar caché de apt (Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Instalar paquetes necesarios para Docker (Debian/Ubuntu)
      package:
        name: "{{ item }}"
        state: present
      loop:
        - ca-certificates
        - curl
        - gnupg
        - lsb-release
      when: ansible_os_family == "Debian"

    - name: Agregar la clave GPG oficial de Docker
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      when: ansible_os_family == "Debian"

    - name: Agregar el repositorio APT de Docker
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Instalar Docker Engine, CLI, Containerd y plugins
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Asegurar que Docker esté iniciado y habilitado
      service:
        name: docker
        state: started
        enabled: yes

    - name: Añadir el usuario actual al grupo 'docker' para ejecutar sin sudo (opcional)
      user:
        name: "{{ ansible_user }}" # Usuario que ejecuta Ansible
        groups: docker
        append: yes
      when: ansible_os_family == "Debian"
---
# Nombre: ansible_configure_firewall_ufw.yml
# Playbook Ansible para configurar el firewall UFW (Uncomplicated Firewall)

- hosts: all
  become: true

  vars:
    # Lista de puertos y protocolos permitidos
    allowed_ports:
      - { port: "22", proto: "tcp" }  # SSH
      - { port: "80", proto: "tcp" }  # HTTP
      - { port: "443", proto: "tcp" } # HTTPS
    # Puedes añadir más reglas aquí, por ejemplo, para permitir conexiones a Docker
    # - { rule: "allow", name: "docker" }

  tasks:
    - name: Asegurar que UFW esté instalado
      package:
        name: ufw
        state: present
      when: ansible_os_family == "Debian"

    - name: Establecer política por defecto (denegar entrada, permitir salida)
      ufw:
        state: enabled
        policy: deny
        direction: incoming
      when: ansible_os_family == "Debian"

    - name: Permitir tráfico en los puertos especificados
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop: "{{ allowed_ports }}"
      when: ansible_os_family == "Debian"
      notify:
        - Recargar UFW

    # Ejemplo de cómo permitir un servicio específico (si está definido en /etc/ufw/applications.d/)
    # - name: Permitir tráfico para el servicio 'Nginx Full'
    #   ufw:
    #     rule: allow
    #     name: "Nginx Full"
    #   when: ansible_os_family == "Debian"
    #   notify:
    #     - Recargar UFW

    - name: Permitir todo el tráfico saliente
      ufw:
        direction: outgoing
        policy: allow
      when: ansible_os_family == "Debian"

  handlers:
    - name: Recargar UFW
      command: sudo ufw reload
      when: ansible_os_family == "Debian"